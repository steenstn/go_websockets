<style>
    body {
        background-color: #444;
    }
    canvas {
        border: 1px solid #eee;
        image-rendering: optimizeSpeed; /* Older versions of FF          */
        image-rendering: -moz-crisp-edges; /* FF 6.0+                       */
        image-rendering: -o-crisp-edges; /* OS X & Windows Opera (12.02+) */
        image-rendering: pixelated; /* Awesome future-browsers       */
        -ms-interpolation-mode: nearest-neighbor; /* IE                            */
        position: absolute;
        top: 10%;
        left: 20%;
    }
</style>
<pre id="output"></pre>
<input id="input" type="text" value="localhost"/>
<button id="connectButton" onclick="connectAndInitialize()">Connect</button>
<canvas id="c"></canvas>
<script>

    let autoConnect = true;
    let socket;
    let keyDownCounter = 0;
    const MessageType = {
        TextMessage: 0,
        PositionUpdate: 1,
    };
    const levelWidth = 50;
    const levelHeight = 50;
    const scale = 8;
    const canvasWidth = levelWidth * scale;
    const canvasHeight = levelHeight * scale;
    let c = document.getElementById('c');

    let input = document.getElementById("input");
input.value = document.location.href.replace(/https?:\/\//g, "").replace(":8080/", "");

    c.width = canvasWidth;
    c.height = canvasHeight;
    let ctx = c.getContext('2d');
    ctx.fillStyle = "#000";
    let output = document.getElementById("output");

    let keysDown = {};
    let keysHit = {};

    if (autoConnect) {
        connectAndInitialize();
    }

    function connectAndInitialize() {
        let trimmedValue = input.value.replace(/https?:\/\//g, "")

        socket = new WebSocket("ws://" + trimmedValue + ":8080/game");
        addEventListener("keydown", function (e) {

            console.log("down " + e.key)
            keysDown[e.key] = true;
            keyDownCounter++;
            if (keyDownCounter === 1) {
                keysHit[e.key] = true;
            }
        }, false);

        addEventListener("keyup", function (e) {
            console.log(e.key)
            keyDownCounter = 0;
            delete keysDown[e.key];
            delete keysHit[e.key];
        }, false);

        socket.onopen = () => {
            output.innerHTML += "Status: Connected\n";
        };

        socket.onmessage = function (e) {
            let json = JSON.parse(e.data)
            let type = json.Type
            let message = atob(json.Msg);
            //console.log(message)
            switch (type) {
                case MessageType.TextMessage:
                    ctx.fillText(message, 10, 50);
                    break;
                case MessageType.PositionUpdate:
                    handlePositionUpdate(message);
                    break;
                default:
                    console.log("Unknown type " + type)
            }

        };
        setInterval(gameLoop, 30);
    }


    function handlePositionUpdate(message) {
        let data = JSON.parse(message);
        //console.log(data)
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        let players = data.Players;
        for (let i = 0; i < players.length; i++) {
            for(let j = 0; j < players[i].Tail.length; j++) {
                ctx.fillStyle = "#fff"
                ctx.fillRect(players[i].Tail[j].X* scale,players[i].Tail[j].Y * scale, scale, scale);
            }
        }

        let pickups = data.Pickups
        for(let i=0; i < pickups.length; i++) {
            ctx.fillStyle = "#d43";
            ctx.fillRect(pickups[i].X * scale, pickups[i].Y * scale, scale, scale);
        }
    }

    function gameLoop() {
        if ("ArrowUp" in keysDown) {
            socket.send("up");
        } else if ("ArrowDown" in keysDown) {
            socket.send("down");
        }
        if ("ArrowLeft" in keysDown) {
            socket.send("left");
        } else if ("ArrowRight" in keysDown) {
            socket.send("right");
        }
        if ("x" in keysHit) {
            socket.send("space");
            delete keysHit["x"];
        }
    }

</script>
