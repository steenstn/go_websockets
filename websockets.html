<style>
    canvas {
        border: 1px solid #666;
        image-rendering: optimizeSpeed; /* Older versions of FF          */
        image-rendering: -moz-crisp-edges; /* FF 6.0+                       */
        image-rendering: -o-crisp-edges; /* OS X & Windows Opera (12.02+) */
        image-rendering: pixelated; /* Awesome future-browsers       */
        -ms-interpolation-mode: nearest-neighbor; /* IE                            */
        position: absolute;
        top: 20%;
        left: 20%;
    }
</style>
<pre id="output"></pre>
<input id="input" type="text" value="localhost:8080"/>
<button onclick="connectAndInitialize()">Connect</button>
<canvas id="c"></canvas>
<script>

    let autoConnect = true;
    let socket;
    const MessageType = {
        TextMessage: 0,
        PositionUpdate: 1,
    };
    const levelWidth = 640;
    const levelHeight = 480;
    let c = document.getElementById('c');

    let input = document.getElementById("input");
    c.width = levelWidth;
    c.height = levelHeight;
    let ctx = c.getContext('2d');
    ctx.fillStyle = "#000";
    let output = document.getElementById("output");

    let keysDown = {};
    if (autoConnect) {
        connectAndInitialize();
    }

    function connectAndInitialize() {
        socket = new WebSocket("ws://" + input.value + "/game");
        addEventListener("keydown", function (e) {
            keysDown[e.key] = true;
        }, false);

        addEventListener("keyup", function (e) {
            console.log(e.key)
            if(e.key === "ArrowUp") {
                socket.send("down");
            }
            delete keysDown[e.key];
        }, false);


        socket.onopen = () => {
            output.innerHTML += "Status: Connected\n";
        };

        socket.onmessage = function (e) {
            //console.log("Server: " + e.data)
            let json = JSON.parse(e.data)
            let type = json.Type
            let message = atob(json.Msg);
            switch (type) {
                case MessageType.TextMessage:
                    ctx.fillText(message, 10, 50);
                    break;
                case MessageType.PositionUpdate:
                    handlePositionUpdate(message);
                    break;
                default:
                    console.log("Unknown type " + type)
            }

        };

        setInterval(gameLoop, 30);
    }


    function handlePositionUpdate(message) {
        let data = JSON.parse(message);
        //console.log(data)
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, levelWidth, levelHeight);
        ctx.fillStyle = "#000"
        let players = data.Players;
        for (let i = 0; i < players.length; i++) {
            let x = players[i].X;
            let y = players[i].Y;
            ctx.beginPath();
            ctx.arc(x, y, 10, 0, 2 * Math.PI);
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(x+4, y+4);
            ctx.lineTo(x+15*Math.cos(players[i].Direction), y+15*Math.sin(players[i].Direction));
            ctx.stroke();
        }

        ctx.fillStyle = "#00f"
        let asteroids = data.Asteroids;
        for (let i = 0; i < asteroids.length; i++) {
            let x = asteroids[i].X;
            let y = asteroids[i].Y;
            ctx.beginPath();
            ctx.arc(x, y, asteroids[i].Size*10, 0, 2 * Math.PI);
            ctx.fill();
        }
        ctx.fillStyle = "#f0f"
        let bullets = data.Bullets;
        for (let i = 0; i < bullets.length; i++) {
            let x = bullets[i].X;
            let y = bullets[i].Y;
            ctx.beginPath();
            ctx.arc(x, y,3, 0, 2 * Math.PI);
            ctx.fill();
        }
    }

    function gameLoop() {
        if ("ArrowUp" in keysDown) {
            socket.send("up");
        } else if("ArrowDown" in keysDown) {
            socket.send("down");
        }
        if ("ArrowLeft" in keysDown) {
            socket.send("left");
        } else if ("ArrowRight" in keysDown) {
            socket.send("right");
        }
        if("x" in keysDown) {
            socket.send("space");
        }
    }

</script>
